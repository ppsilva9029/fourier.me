"use client"

import { useEffect, useState } from "react"
import { ModeToggle } from "@/components/ui/toggle-mode"
import {io, Socket} from 'socket.io-client'
import { useToast } from "@/components/ui/use-toast"
import { ToastAction } from "@/components/ui/toast"

import ImageSelector from "@/components/image-select"
import Epicycles from "@/components/epicycle-canvas"
import LineartPreview from "@/components/lineart-preview"


let socketConn : Socket;

const dummyVectorData = [
  [
      1.6773,
      -0.1287,
      -0.3586,
      -1.6385
  ],
  [
      1.5913,
      0.0429,
      -0.9268,
      1.2936
  ],
  [
      1.435,
      -0.0858,
      0.2134,
      1.419
  ],
  [
      1.2319,
      0.0858,
      0.2232,
      1.2115
  ],
  [
      1.1238,
      -0.0429,
      0.6942,
      0.8838
  ],
  [
      0.7981,
      0,
      0.7629,
      -0.2344
  ],
  [
      0.7558,
      0.1716,
      0.472,
      0.5903
  ],
  [
      0.5304,
      0.1287,
      -0.0593,
      0.5271
  ],
  [
      0.4235,
      0.2573,
      -0.2305,
      0.3553
  ],
  [
      0.3917,
      -0.3002,
      -0.3089,
      0.2409
  ],
  [
      0.3578,
      0.3002,
      0.3576,
      0.0136
  ],
  [
      0.2865,
      -0.2144,
      -0.1466,
      0.2462
  ],
  [
      0.2267,
      -0.4718,
      0.2078,
      -0.0906
  ],
  [
      0.2196,
      0.3431,
      -0.1782,
      0.1283
  ],
  [
      0.2187,
      -0.386,
      0.2141,
      -0.0447
  ],
  [
      0.2156,
      0.2144,
      0.2155,
      -0.0079
  ],
  [
      0.1897,
      -0.2573,
      0.0149,
      -0.1891
  ],
  [
      0.183,
      -0.3431,
      0.1549,
      0.0974
  ],
  [
      0.1373,
      0.4718,
      0.0421,
      0.1306
  ],
  [
      0.1332,
      0.5147,
      0.059,
      -0.1194
  ],
  [
      0.1322,
      0.5576,
      -0.1257,
      0.041
  ],
  [
      0.1236,
      0.4289,
      -0.0882,
      -0.0866
  ],
  [
      0.1217,
      0.386,
      0.0476,
      0.112
  ],
  [
      0.1202,
      -0.5147,
      -0.0628,
      -0.1025
  ],
  [
      0.1177,
      0.6862,
      0.1049,
      0.0533
  ],
  [
      0.0983,
      -0.1716,
      0.0963,
      -0.0196
  ],
  [
      0.0965,
      1.0293,
      -0.0743,
      -0.0616
  ],
  [
      0.0953,
      0.7291,
      -0.0355,
      -0.0884
  ],
  [
      0.0904,
      -1.0722,
      0.0874,
      -0.0232
  ],
  [
      0.0864,
      -0.9864,
      0.0413,
      0.0758
  ],
  [
      0.0845,
      1.0722,
      0.0348,
      0.077
  ],
  [
      0.0825,
      0.9007,
      0.0725,
      -0.0395
  ],
  [
      0.0787,
      0.6433,
      -0.0706,
      -0.0349
  ],
  [
      0.0775,
      1.2438,
      -0.0774,
      0.0025
  ],
  [
      0.0721,
      0.8578,
      -0.0512,
      0.0507
  ],
  [
      0.0719,
      -0.4289,
      -0.0717,
      -0.0043
  ],
  [
      0.0669,
      -1.2009,
      -0.013,
      0.0656
  ],
  [
      0.0661,
      0.6004,
      -0.04,
      -0.0527
  ],
  [
      0.066,
      -0.5576,
      -0.0204,
      0.0628
  ],
  [
      0.0658,
      0.772,
      0.0458,
      0.0473
  ],
  [
      0.0608,
      -0.9436,
      -0.057,
      0.0213
  ],
  [
      0.0607,
      1.158,
      0.0043,
      0.0606
  ],
  [
      0.0603,
      0.9436,
      -0.0567,
      0.0204
  ],
  [
      0.0593,
      -0.6433,
      -0.0368,
      -0.0466
  ],
  [
      0.0579,
      1.3295,
      -0.0531,
      0.023
  ],
  [
      0.0565,
      1.5011,
      0.0346,
      -0.0447
  ],
  [
      0.0548,
      1.2867,
      0.051,
      -0.0202
  ],
  [
      0.0519,
      -0.8149,
      -0.0513,
      -0.0077
  ],
  [
      0.051,
      -1.2438,
      0.0032,
      -0.0509
  ],
  [
      0.0499,
      0.8149,
      -0.0349,
      -0.0357
  ],
  [
      0.0491,
      1.2009,
      0.0358,
      -0.0335
  ],
  [
      0.0483,
      -1.158,
      0.0121,
      -0.0467
  ],
  [
      0.0477,
      -1.3295,
      -0.0307,
      -0.0366
  ],
  [
      0.0473,
      -1.0293,
      -0.0471,
      -0.004
  ],
  [
      0.0463,
      -0.9007,
      0.0377,
      0.0269
  ],
  [
      0.042,
      -0.6862,
      0.0381,
      -0.0178
  ],
  [
      0.0406,
      1.1151,
      -0.0142,
      -0.038
  ],
  [
      0.0383,
      0.9864,
      0.0381,
      0.0034
  ],
  [
      0.0377,
      -1.2867,
      0.0324,
      0.0193
  ],
  [
      0.0373,
      -1.4153,
      -0.0356,
      0.0113
  ],
  [
      0.0362,
      -0.772,
      -0.0082,
      0.0352
  ],
  [
      0.0359,
      -0.7291,
      -0.0354,
      0.0063
  ],
  [
      0.0352,
      1.6727,
      0.0056,
      0.0348
  ],
  [
      0.0331,
      -1.3724,
      0.033,
      -0.0013
  ],
  [
      0.0331,
      -1.8871,
      0.0219,
      0.0248
  ],
  [
      0.0319,
      -1.5011,
      -0.0231,
      0.0219
  ],
  [
      0.0318,
      2.0587,
      -0.0212,
      0.0238
  ],
  [
      0.0302,
      -2.1444,
      -0.014,
      -0.0267
  ],
  [
      0.0299,
      -1.4582,
      0.0185,
      -0.0234
  ],
  [
      0.0289,
      3.0022,
      0.0278,
      -0.0079
  ],
  [
      0.0288,
      -2.2302,
      -0.0224,
      -0.0181
  ],
  [
      0.0287,
      2.4875,
      0.0136,
      0.0253
  ],
  [
      0.0285,
      2.2302,
      0.0004,
      -0.0285
  ],
  [
      0.0278,
      -2.0587,
      0.0222,
      -0.0167
  ],
  [
      0.0273,
      1.7155,
      -0.0181,
      -0.0205
  ],
  [
      0.0272,
      -1.1151,
      -0.0264,
      -0.0064
  ],
  [
      0.0269,
      -1.8013,
      -0.0057,
      0.0263
  ],
  [
      0.0264,
      -1.544,
      -0.0029,
      -0.0262
  ],
  [
      0.0263,
      -2.2731,
      0.0242,
      0.0101
  ],
  [
      0.0261,
      2.8735,
      0.0005,
      0.0261
  ],
  [
      0.0261,
      1.4582,
      -0.0199,
      0.0169
  ],
  [
      0.0258,
      -1.5869,
      0.006,
      0.0251
  ],
  [
      0.0255,
      3.0451,
      -0.0231,
      -0.0109
  ],
  [
      0.0253,
      -1.7155,
      -0.0222,
      0.012
  ],
  [
      0.0253,
      -1.8442,
      -0.0071,
      -0.0243
  ],
  [
      0.0253,
      -2.4018,
      -0.0064,
      0.0245
  ],
  [
      0.0251,
      2.316,
      0.0069,
      -0.0242
  ],
  [
      0.0249,
      1.8442,
      -0.0246,
      0.0043
  ],
  [
      0.0244,
      1.93,
      -0.0227,
      -0.0089
  ],
  [
      0.024,
      2.6591,
      -0.0185,
      0.0152
  ],
  [
      0.0239,
      3.2595,
      -0.0072,
      0.0228
  ],
  [
      0.0239,
      1.5869,
      0.0099,
      -0.0217
  ],
  [
      0.023,
      1.6298,
      -0.0139,
      -0.0183
  ],
  [
      0.0225,
      -2.1015,
      0.0089,
      0.0207
  ],
  [
      0.0218,
      2.2731,
      0.0073,
      0.0206
  ],
  [
      0.0214,
      -2.6591,
      0.0144,
      -0.0158
  ],
  [
      0.0213,
      -2.4447,
      -0.0009,
      -0.0213
  ],
  [
      0.0212,
      -2.0158,
      -0.0132,
      0.0166
  ],
  [
      0.0212,
      -2.1873,
      0.0124,
      0.0172
  ],
  [
      0.0208,
      -4.0315,
      -0.0206,
      -0.0035
  ],
  [
      0.0206,
      3.9886,
      0.014,
      0.0151
  ],
  [
      0.0201,
      2.6162,
      0.0118,
      -0.0163
  ],
  [
      0.02,
      3.474,
      0.0041,
      0.0195
  ],
  [
      0.0196,
      3.2166,
      0.0174,
      -0.0092
  ],
  [
      0.0196,
      -1.6298,
      -0.0104,
      -0.0166
  ],
  [
      0.0196,
      -2.4875,
      0.0048,
      0.019
  ],
  [
      0.0195,
      3.1738,
      0.0016,
      0.0194
  ],
  [
      0.0193,
      2.7449,
      -0.0193,
      0.0008
  ],
  [
      0.0192,
      3.088,
      0.0181,
      0.0066
  ],
  [
      0.0192,
      1.8871,
      0.0183,
      -0.0058
  ],
  [
      0.0191,
      4.246,
      -0.0191,
      0.0002
  ],
  [
      0.0189,
      3.4311,
      -0.0063,
      -0.0178
  ],
  [
      0.0188,
      -1.6727,
      0.0172,
      0.0076
  ],
  [
      0.0184,
      -1.93,
      -0.0041,
      -0.0179
  ],
  [
      0.0184,
      -3.6026,
      0.006,
      0.0174
  ],
  [
      0.0182,
      4.8035,
      0.017,
      0.0066
  ],
  [
      0.0178,
      2.1015,
      0.0103,
      -0.0146
  ],
  [
      0.0178,
      -3.9458,
      -0.0169,
      -0.0057
  ],
  [
      0.0177,
      -2.6162,
      -0.0127,
      0.0124
  ],
  [
      0.0175,
      3.6455,
      -0.0171,
      0.0033
  ],
  [
      0.0173,
      1.8013,
      0.0138,
      -0.0105
  ],
  [
      0.0171,
      3.1309,
      -0.0111,
      -0.013
  ],
  [
      0.0169,
      4.0744,
      0.0074,
      0.0152
  ],
  [
      0.0168,
      3.8171,
      0.007,
      -0.0153
  ],
  [
      0.0168,
      3.6026,
      0.0167,
      0.0012
  ],
  [
      0.0166,
      2.4447,
      -0.0165,
      0.002
  ],
  [
      0.0166,
      -3.9886,
      0.0153,
      0.0065
  ],
  [
      0.0158,
      2.5733,
      -0.0101,
      0.0122
  ],
  [
      0.0158,
      1.4153,
      0.008,
      -0.0136
  ],
  [
      0.0157,
      -2.7878,
      0.0111,
      0.0111
  ],
  [
      0.0157,
      -4.2031,
      0.0034,
      0.0153
  ],
  [
      0.0156,
      3.86,
      -0.013,
      0.0087
  ],
  [
      0.0155,
      2.9164,
      0.0103,
      -0.0115
  ],
  [
      0.0154,
      5.79,
      0.0068,
      0.0137
  ],
  [
      0.0152,
      -4.5891,
      0.0116,
      0.0098
  ],
  [
      0.015,
      3.3024,
      0.0117,
      -0.0094
  ],
  [
      0.015,
      -1.9729,
      0.0146,
      -0.0036
  ],
  [
      0.0146,
      2.8307,
      -0.0021,
      -0.0145
  ],
  [
      0.0146,
      -3.2166,
      -0.0104,
      0.0102
  ],
  [
      0.0144,
      -2.9593,
      -0.0064,
      -0.0129
  ],
  [
      0.0143,
      3.3882,
      0.0039,
      0.0138
  ],
  [
      0.0136,
      -3.0022,
      0.0029,
      0.0133
  ],
  [
      0.0134,
      2.1444,
      -0.0102,
      -0.0086
  ],
  [
      0.0133,
      -4.3318,
      -0.0124,
      0.0049
  ],
  [
      0.0132,
      -6.5191,
      -0.0022,
      0.013
  ],
  [
      0.0131,
      4.2889,
      0.011,
      0.007
  ],
  [
      0.0131,
      3.5169,
      0.0037,
      -0.0126
  ],
  [
      0.013,
      5.3611,
      -0.013,
      0.0002
  ],
  [
      0.0128,
      -4.3746,
      0.0126,
      -0.0023
  ],
  [
      0.0127,
      4.9751,
      -0.0089,
      0.0091
  ],
  [
      0.0127,
      2.4018,
      0.0127,
      0.0015
  ],
  [
      0.0126,
      5.2324,
      -0.0021,
      -0.0125
  ],
  [
      0.0125,
      3.5598,
      -0.0074,
      0.01
  ],
  [
      0.0124,
      -4.4604,
      0.0039,
      -0.0117
  ],
  [
      0.0123,
      6.948,
      -0.0036,
      -0.0117
  ],
  [
      0.0123,
      2.5304,
      -0.0101,
      0.0071
  ],
  [
      0.0123,
      -3.0451,
      -0.0039,
      -0.0116
  ],
  [
      0.0122,
      4.2031,
      0.0112,
      0.0047
  ],
  [
      0.012,
      4.4604,
      -0.0086,
      0.0083
  ],
  [
      0.012,
      -2.3589,
      -0.0075,
      -0.0094
  ],
  [
      0.0119,
      5.6184,
      0.0089,
      -0.0079
  ],
  [
      0.0119,
      2.0158,
      0.0062,
      -0.0102
  ],
  [
      0.0118,
      2.9593,
      -0.0118,
      -0.0006
  ],
  [
      0.0118,
      -2.316,
      -0.0112,
      -0.0036
  ],
  [
      0.0118,
      -3.6455,
      -0.0024,
      -0.0115
  ],
  [
      0.0117,
      6.0044,
      0.0102,
      0.0058
  ],
  [
      0.0117,
      3.6884,
      0.011,
      0.004
  ],
  [
      0.0116,
      -0.8578,
      0.0036,
      -0.0111
  ],
  [
      0.0116,
      -3.6884,
      0.0077,
      0.0087
  ],
  [
      0.0115,
      6.6049,
      0.0115,
      -0.0001
  ],
  [
      0.0115,
      -3.3453,
      -0.0101,
      -0.0054
  ],
  [
      0.0115,
      -4.1173,
      -0.0102,
      0.0052
  ],
  [
      0.0114,
      8.5348,
      0.0063,
      -0.0095
  ],
  [
      0.0113,
      5.9615,
      -0.0113,
      0.0004
  ],
  [
      0.0113,
      3.7742,
      -0.0025,
      0.011
  ],
  [
      0.0113,
      -4.4175,
      -0.0085,
      0.0074
  ],
  [
      0.0112,
      5.8329,
      -0.0007,
      -0.0112
  ],
  [
      0.0111,
      -4.5462,
      -0.0063,
      -0.0092
  ],
  [
      0.0111,
      -6.3475,
      -0.0102,
      -0.0042
  ],
  [
      0.0109,
      1.3724,
      0.01,
      0.0044
  ],
  [
      0.0109,
      -3.474,
      0.0108,
      -0.0006
  ],
  [
      0.0108,
      4.4175,
      0.0002,
      -0.0108
  ],
  [
      0.0108,
      -2.7449,
      0.001,
      -0.0107
  ],
  [
      0.0107,
      3.3453,
      -0.0092,
      -0.0054
  ],
  [
      0.0107,
      -3.7742,
      0.0095,
      -0.005
  ],
  [
      0.0107,
      -3.9029,
      0.0093,
      0.0053
  ],
  [
      0.0106,
      6.2189,
      0.0061,
      -0.0087
  ],
  [
      0.0106,
      5.1895,
      0.0003,
      0.0106
  ],
  [
      0.0106,
      4.632,
      0.0018,
      -0.0105
  ],
  [
      0.0105,
      4.3746,
      -0.0003,
      0.0104
  ],
  [
      0.0105,
      1.544,
      -0.0103,
      0.002
  ],
  [
      0.0105,
      -5.1466,
      -0.0097,
      -0.004
  ],
  [
      0.0105,
      -5.5755,
      0.0098,
      -0.0038
  ],
  [
      0.0104,
      6.0473,
      -0.01,
      -0.0028
  ],
  [
      0.0104,
      -5.404,
      0.0024,
      0.0101
  ],
  [
      0.0104,
      -6.7764,
      0.009,
      -0.0052
  ],
  [
      0.0103,
      5.0609,
      -0.0093,
      0.0042
  ],
  [
      0.0103,
      -6.7335,
      -0.008,
      0.0064
  ],
  [
      0.0102,
      5.7042,
      0.0073,
      0.0071
  ],
  [
      0.0102,
      3.9029,
      0.0091,
      -0.0045
  ],
  [
      0.0102,
      -2.702,
      -0.0101,
      0.0009
  ],
  [
      0.0102,
      -4.632,
      -0.0092,
      -0.0043
  ],
  [
      0.0101,
      5.5326,
      0.0058,
      -0.0083
  ],
  [
      0.0101,
      -3.2595,
      0.0055,
      -0.0085
  ],
  [
      0.01,
      5.5755,
      -0.0071,
      0.0071
  ],
  [
      0.01,
      -3.86,
      0.0026,
      -0.0097
  ]
]

export default function Home() {

  const [lineartPreview, setLineartPreview] = useState<string | undefined>(undefined);
  const [vectorData, setVectorData] = useState<number[][] | undefined>(undefined);
  const {toast} = useToast();

  useEffect(() => {
    socketInitializer();

    return () => {
      socketConn.disconnect();
    };
  }, []);

  function socketInitializer() {
    socketConn = io(`${process.env.NEXT_PUBLIC_SERVER_URL}/fourierify`)

    socketConn.on('connect', () => {
      console.log('Connected to server');
    });

    socketConn.on('lineart', (url: string) => {
      setLineartPreview(url);
    });
  
    socketConn.on('vectorData', (data: number[][]) => {
      setLineartPreview(undefined);
      setVectorData(data);
      console.log("vectorData fetched", data);
    });
  }

  function getVectors( e: React.MouseEvent<HTMLButtonElement, MouseEvent>, file: File | null, setImageSubmitted: React.Dispatch<React.SetStateAction<boolean>>){
    e.preventDefault();

    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event: ProgressEvent<FileReader>) {
      if(!event.target || !socketConn){
        toast({
          variant: "destructive",
          title: "Uh oh! Something went wrong.",
          description: "There was a problem with your request. Try reloading the page.",
          action: <ToastAction altText="Reload" onClick={()=> window.location.reload()}>Reload</ToastAction>,
        })
        return;
      }
      try{
        socketConn.emit('imageUpload', event.target.result);
        
        toast({
          title: "Image uploaded!",
          description: "Your image has been uploaded. Please wait while we process it.",
        })
        console.log('image emitted');
        setImageSubmitted(true);
        return;
      } catch (err) {
        console.log(err);
        toast({
          variant: "destructive",
          title: "Uh oh! Something went wrong.",
          description: "There was a problem with your image",
          // action: <ToastAction altText="Reload" onClick={()=> window.location.reload()}>Reload</ToastAction>,
        })
        return;
      }
    };
    reader.readAsDataURL(file);
  }

  return (
    <>
    <nav className="text-right mt-5 mr-5">
        <ModeToggle />
    </nav>
    <main className="flex flex-col items-center justify-center m-0">
      <h1
        className="text-6xl md:text-8xl font-bold text-center mt-15"
      >
        fourier.me
      </h1>
      <h2
        className="text-xl md:text-3xl text-muted-foreground text-center mt-5 px-10"
      >
        generate Fourier Epicycle Animations from your own images!
      </h2>
      <div className="mt-10">
        {!lineartPreview && !vectorData && 
          <ImageSelector getVectors={getVectors} />}
        
        {lineartPreview && !vectorData && (
          <LineartPreview imgUrl={lineartPreview} />
        )}

        {!lineartPreview && vectorData && 
        // <Epicycles vector_data={vectorData} setVectorData={setVectorData}/>
          <Epicycles vector_data={vectorData} setVectorData={setVectorData}/>
        }
      </div>
      
    </main>
    </>
  )
}
